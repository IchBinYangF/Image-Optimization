"use strict";
// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
// SPDX-License-Identifier: MIT-0
Object.defineProperty(exports, "__esModule", { value: true });
exports.ImageOptimizationStack = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const my_custom_resource_1 = require("./my-custom-resource");
const crypto_1 = require("crypto");
// Region to Origin Shield mapping based on latency. to be updated when new Regional Edge Caches are added to CloudFront.
const ORIGIN_SHIELD_MAPPING = new Map([['af-south-1', 'eu-west-2'], ['ap-east-1', 'ap-northeast-2'], ['ap-northeast-1', 'ap-northeast-1'], [
        'ap-northeast-2', 'ap-northeast-2'
    ], ['ap-northeast-3', 'ap-northeast-1'], ['ap-south-1', 'ap-south-1'], ['ap-southeast-1', 'ap-southeast-1'], [
        'ap-southeast-2', 'ap-southeast-2'
    ], ['ca-central-1', 'us-east-1'], ['eu-central-1', 'eu-central-1'], ['eu-north-1', 'eu-central-1'], [
        'eu-south-1', 'eu-central-1'
    ], ['eu-west-1', 'eu-west-1'], ['eu-west-2', 'eu-west-2'], ['eu-west-3', 'eu-west-2'], ['me-south-1', 'ap-south-1'], [
        'sa-east-1', 'sa-east-1'
    ], ['us-east-1', 'us-east-1'], ['us-east-2', 'us-east-2'], ['us-west-1', 'us-west-1'], ['us-west-2', 'us-west-2']]);
// Stack Parameters
// related to architecture. If set to false, transformed images are not stored in S3, and all image requests land on Lambda
var STORE_TRANSFORMED_IMAGES = 'true';
// Parameters of S3 bucket where original images are stored
var S3_IMAGE_BUCKET_NAME;
// CloudFront parameters
var CLOUDFRONT_ORIGIN_SHIELD_REGION = ORIGIN_SHIELD_MAPPING.get(process.env.AWS_REGION || process.env.CDK_DEFAULT_REGION || 'us-east-1');
var CLOUDFRONT_CORS_ENABLED = 'true';
// Parameters of transformed images
var S3_TRANSFORMED_IMAGE_EXPIRATION_DURATION = '90';
var S3_TRANSFORMED_IMAGE_CACHE_TTL = 'max-age=31622400';
// Lambda Parameters
var LAMBDA_MEMORY = '1500';
var LAMBDA_TIMEOUT = '60';
var LOG_TIMING = 'false';
class ImageOptimizationStack extends aws_cdk_lib_1.Stack {
    constructor(scope, id, props) {
        var _a;
        super(scope, id, props);
        // Change stack parameters based on provided context
        STORE_TRANSFORMED_IMAGES = this.node.tryGetContext('STORE_TRANSFORMED_IMAGES') || STORE_TRANSFORMED_IMAGES;
        S3_TRANSFORMED_IMAGE_EXPIRATION_DURATION = this.node.tryGetContext('S3_TRANSFORMED_IMAGE_EXPIRATION_DURATION') || S3_TRANSFORMED_IMAGE_EXPIRATION_DURATION;
        S3_TRANSFORMED_IMAGE_CACHE_TTL = this.node.tryGetContext('S3_TRANSFORMED_IMAGE_CACHE_TTL') || S3_TRANSFORMED_IMAGE_CACHE_TTL;
        S3_IMAGE_BUCKET_NAME = this.node.tryGetContext('S3_IMAGE_BUCKET_NAME') || S3_IMAGE_BUCKET_NAME;
        CLOUDFRONT_ORIGIN_SHIELD_REGION = this.node.tryGetContext('CLOUDFRONT_ORIGIN_SHIELD_REGION') || CLOUDFRONT_ORIGIN_SHIELD_REGION;
        CLOUDFRONT_CORS_ENABLED = this.node.tryGetContext('CLOUDFRONT_CORS_ENABLED') || CLOUDFRONT_CORS_ENABLED;
        LAMBDA_MEMORY = this.node.tryGetContext('LAMBDA_MEMORY') || LAMBDA_MEMORY;
        LAMBDA_TIMEOUT = this.node.tryGetContext('LAMBDA_TIMEOUT') || LAMBDA_TIMEOUT;
        LOG_TIMING = this.node.tryGetContext('LOG_TIMING') || LOG_TIMING;
        // Create secret key to be used between CloudFront and Lambda URL for access control
        const SECRET_KEY = (0, crypto_1.createHash)('md5').update(this.node.addr).digest('hex');
        // For the bucket having original images, either use an external one, or create one with some samples photos.
        var originalImageBucket;
        var transformedImageBucket;
        var sampleWebsiteDelivery;
        if (S3_IMAGE_BUCKET_NAME) {
            originalImageBucket = aws_cdk_lib_1.aws_s3.Bucket.fromBucketName(this, 'imported-original-image-bucket', S3_IMAGE_BUCKET_NAME);
            new aws_cdk_lib_1.CfnOutput(this, 'OriginalImagesS3Bucket', {
                description: 'S3 bucket where original images are stored',
                value: originalImageBucket.bucketName
            });
        }
        else {
            originalImageBucket = new aws_cdk_lib_1.aws_s3.Bucket(this, 's3-sample-original-image-bucket', {
                removalPolicy: aws_cdk_lib_1.RemovalPolicy.DESTROY,
                blockPublicAccess: aws_cdk_lib_1.aws_s3.BlockPublicAccess.BLOCK_ALL,
                encryption: aws_cdk_lib_1.aws_s3.BucketEncryption.S3_MANAGED,
                enforceSSL: true,
                autoDeleteObjects: true,
            });
            new aws_cdk_lib_1.aws_s3_deployment.BucketDeployment(this, 'DeployWebsite', {
                sources: [aws_cdk_lib_1.aws_s3_deployment.Source.asset('./image-sample')],
                destinationBucket: originalImageBucket,
                destinationKeyPrefix: 'images/rio/',
            });
            var sampleWebsiteBucket = new aws_cdk_lib_1.aws_s3.Bucket(this, 's3-sample-website-bucket', {
                removalPolicy: aws_cdk_lib_1.RemovalPolicy.DESTROY,
                blockPublicAccess: aws_cdk_lib_1.aws_s3.BlockPublicAccess.BLOCK_ALL,
                encryption: aws_cdk_lib_1.aws_s3.BucketEncryption.S3_MANAGED,
                enforceSSL: true,
                autoDeleteObjects: true,
            });
            sampleWebsiteDelivery = new aws_cdk_lib_1.aws_cloudfront.Distribution(this, 'websiteDeliveryDistribution', {
                comment: 'image optimization - sample website',
                defaultRootObject: 'index.html',
                defaultBehavior: {
                    origin: new aws_cdk_lib_1.aws_cloudfront_origins.S3Origin(sampleWebsiteBucket),
                    viewerProtocolPolicy: aws_cdk_lib_1.aws_cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS,
                }
            });
            new aws_cdk_lib_1.CfnOutput(this, 'SampleWebsiteDomain', {
                description: 'Sample website domain',
                value: sampleWebsiteDelivery.distributionDomainName
            });
            new aws_cdk_lib_1.CfnOutput(this, 'SampleWebsiteS3Bucket', {
                description: 'S3 bucket use by the sample website',
                value: sampleWebsiteBucket.bucketName
            });
            new aws_cdk_lib_1.CfnOutput(this, 'OriginalImagesS3Bucket', {
                description: 'S3 bucket where original images are stored',
                value: originalImageBucket.bucketName
            });
        }
        // create bucket for transformed images if enabled in the architecture
        if (STORE_TRANSFORMED_IMAGES === 'true') {
            transformedImageBucket = new aws_cdk_lib_1.aws_s3.Bucket(this, 's3-transformed-image-bucket', {
                removalPolicy: aws_cdk_lib_1.RemovalPolicy.DESTROY,
                autoDeleteObjects: true,
                lifecycleRules: [
                    {
                        expiration: aws_cdk_lib_1.Duration.days(parseInt(S3_TRANSFORMED_IMAGE_EXPIRATION_DURATION)),
                    },
                ],
            });
        }
        // prepare env variable for Lambda 
        var lambdaEnv = {
            originalImageBucketName: originalImageBucket.bucketName,
            transformedImageCacheTTL: S3_TRANSFORMED_IMAGE_CACHE_TTL,
            secretKey: SECRET_KEY,
            logTiming: LOG_TIMING,
        };
        if (transformedImageBucket)
            lambdaEnv.transformedImageBucketName = transformedImageBucket.bucketName;
        // IAM policy to read from the S3 bucket containing the original images
        const s3ReadOriginalImagesPolicy = new aws_cdk_lib_1.aws_iam.PolicyStatement({
            actions: ['s3:GetObject'],
            resources: ['arn:aws:s3:::' + originalImageBucket.bucketName + '/*'],
        });
        // statements of the IAM policy to attach to Lambda
        var iamPolicyStatements = [s3ReadOriginalImagesPolicy];
        // Create Lambda for image processing
        var lambdaProps = {
            runtime: aws_cdk_lib_1.aws_lambda.Runtime.NODEJS_16_X,
            handler: 'index.handler',
            code: aws_cdk_lib_1.aws_lambda.Code.fromAsset('functions/image-processing'),
            timeout: aws_cdk_lib_1.Duration.seconds(parseInt(LAMBDA_TIMEOUT)),
            memorySize: parseInt(LAMBDA_MEMORY),
            environment: lambdaEnv,
            logRetention: aws_cdk_lib_1.aws_logs.RetentionDays.ONE_DAY,
        };
        var imageProcessing = new aws_cdk_lib_1.aws_lambda.Function(this, 'image-optimization', lambdaProps);
        // Enable Lambda URL
        const imageProcessingURL = imageProcessing.addFunctionUrl({
            authType: aws_cdk_lib_1.aws_lambda.FunctionUrlAuthType.NONE,
        });
        // Leverage a custom resource to get the hostname of the LambdaURL
        const imageProcessingHelper = new my_custom_resource_1.MyCustomResource(this, 'customResource', {
            Url: imageProcessingURL.url
        });
        // Create a CloudFront origin: S3 with fallback to Lambda when image needs to be transformed, otherwise with Lambda as sole origin
        var imageOrigin;
        if (transformedImageBucket) {
            imageOrigin = new aws_cdk_lib_1.aws_cloudfront_origins.OriginGroup({
                primaryOrigin: new aws_cdk_lib_1.aws_cloudfront_origins.S3Origin(transformedImageBucket, {
                    originShieldRegion: CLOUDFRONT_ORIGIN_SHIELD_REGION,
                }),
                fallbackOrigin: new aws_cdk_lib_1.aws_cloudfront_origins.HttpOrigin(imageProcessingHelper.hostname, {
                    originShieldRegion: CLOUDFRONT_ORIGIN_SHIELD_REGION,
                    customHeaders: {
                        'x-origin-secret-header': SECRET_KEY,
                    },
                }),
                fallbackStatusCodes: [403],
            });
            // write policy for Lambda on the s3 bucket for transformed images
            var s3WriteTransformedImagesPolicy = new aws_cdk_lib_1.aws_iam.PolicyStatement({
                actions: ['s3:PutObject'],
                resources: ['arn:aws:s3:::' + transformedImageBucket.bucketName + '/*'],
            });
            iamPolicyStatements.push(s3WriteTransformedImagesPolicy);
        }
        else {
            console.log("else transformedImageBucket");
            imageOrigin = new aws_cdk_lib_1.aws_cloudfront_origins.HttpOrigin(imageProcessingHelper.hostname, {
                originShieldRegion: CLOUDFRONT_ORIGIN_SHIELD_REGION,
                customHeaders: {
                    'x-origin-secret-header': SECRET_KEY,
                },
            });
        }
        // attach iam policy to the role assumed by Lambda
        (_a = imageProcessing.role) === null || _a === void 0 ? void 0 : _a.attachInlinePolicy(new aws_cdk_lib_1.aws_iam.Policy(this, 'read-write-bucket-policy', {
            statements: iamPolicyStatements,
        }));
        // Create a CloudFront Function for url rewrites
        const urlRewriteFunction = new aws_cdk_lib_1.aws_cloudfront.Function(this, 'urlRewrite', {
            code: aws_cdk_lib_1.aws_cloudfront.FunctionCode.fromFile({ filePath: 'functions/url-rewrite/index.js', }),
            functionName: `urlRewriteFunction${this.node.addr}`,
        });
        var imageDeliveryCacheBehaviorConfig = {
            origin: imageOrigin,
            viewerProtocolPolicy: aws_cdk_lib_1.aws_cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS,
            cachePolicy: new aws_cdk_lib_1.aws_cloudfront.CachePolicy(this, `ImageCachePolicy${this.node.addr}`, {
                defaultTtl: aws_cdk_lib_1.Duration.hours(24),
                maxTtl: aws_cdk_lib_1.Duration.days(365),
                minTtl: aws_cdk_lib_1.Duration.seconds(0),
                queryStringBehavior: aws_cdk_lib_1.aws_cloudfront.CacheQueryStringBehavior.all()
            }),
            functionAssociations: [{
                    eventType: aws_cdk_lib_1.aws_cloudfront.FunctionEventType.VIEWER_REQUEST,
                    function: urlRewriteFunction,
                }],
        };
        if (CLOUDFRONT_CORS_ENABLED === 'true') {
            // Creating a custom response headers policy. CORS allowed for all origins.
            const imageResponseHeadersPolicy = new aws_cdk_lib_1.aws_cloudfront.ResponseHeadersPolicy(this, `ResponseHeadersPolicy${this.node.addr}`, {
                responseHeadersPolicyName: 'ImageResponsePolicy',
                corsBehavior: {
                    accessControlAllowCredentials: false,
                    accessControlAllowHeaders: ['*'],
                    accessControlAllowMethods: ['GET'],
                    accessControlAllowOrigins: ['*'],
                    accessControlMaxAge: aws_cdk_lib_1.Duration.seconds(600),
                    originOverride: false,
                },
                // recognizing image requests that were processed by this solution
                customHeadersBehavior: {
                    customHeaders: [
                        { header: 'x-aws-image-optimization', value: 'v1.0', override: true },
                        { header: 'vary', value: 'accept', override: true },
                    ],
                }
            });
            imageDeliveryCacheBehaviorConfig.responseHeadersPolicy = imageResponseHeadersPolicy;
        }
        const imageDelivery = new aws_cdk_lib_1.aws_cloudfront.Distribution(this, 'imageDeliveryDistribution', {
            comment: 'image optimization - image delivery',
            defaultBehavior: imageDeliveryCacheBehaviorConfig
        });
        new aws_cdk_lib_1.CfnOutput(this, 'ImageDeliveryDomain', {
            description: 'Domain name of image delivery',
            value: imageDelivery.distributionDomainName
        });
    }
}
exports.ImageOptimizationStack = ImageOptimizationStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1hZ2Utb3B0aW1pemF0aW9uLXN0YWNrLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiaW1hZ2Utb3B0aW1pemF0aW9uLXN0YWNrLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxxRUFBcUU7QUFDckUsaUNBQWlDOzs7QUFFakMsNkNBQXlQO0FBRXpQLDZEQUF3RDtBQUN4RCxtQ0FBb0M7QUFFcEMseUhBQXlIO0FBQ3pILE1BQU0scUJBQXFCLEdBQUcsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDLFlBQVksRUFBRSxXQUFXLENBQUMsRUFBRSxDQUFFLFdBQVcsRUFBRSxnQkFBZ0IsQ0FBQyxFQUFFLENBQUUsZ0JBQWdCLEVBQUUsZ0JBQWdCLENBQUMsRUFBRTtRQUMzSSxnQkFBZ0IsRUFBRSxnQkFBZ0I7S0FBQyxFQUFFLENBQUUsZ0JBQWdCLEVBQUUsZ0JBQWdCLENBQUMsRUFBRSxDQUFFLFlBQVksRUFBRSxZQUFZLENBQUMsRUFBRSxDQUFFLGdCQUFnQixFQUFDLGdCQUFnQixDQUFDLEVBQUU7UUFDakosZ0JBQWdCLEVBQUUsZ0JBQWdCO0tBQUMsRUFBRSxDQUFFLGNBQWMsRUFBRSxXQUFXLENBQUMsRUFBRSxDQUFFLGNBQWMsRUFBRSxjQUFjLENBQUMsRUFBRSxDQUFFLFlBQVksRUFBQyxjQUFjLENBQUMsRUFBRTtRQUN4SSxZQUFZLEVBQUMsY0FBYztLQUFDLEVBQUUsQ0FBRSxXQUFXLEVBQUUsV0FBVyxDQUFDLEVBQUUsQ0FBRSxXQUFXLEVBQUUsV0FBVyxDQUFDLEVBQUUsQ0FBRSxXQUFXLEVBQUUsV0FBVyxDQUFDLEVBQUUsQ0FBRSxZQUFZLEVBQUUsWUFBWSxDQUFDLEVBQUU7UUFDcEosV0FBVyxFQUFFLFdBQVc7S0FBQyxFQUFFLENBQUUsV0FBVyxFQUFFLFdBQVcsQ0FBQyxFQUFFLENBQUUsV0FBVyxFQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUUsV0FBVyxFQUFFLFdBQVcsQ0FBQyxFQUFFLENBQUUsV0FBVyxFQUFFLFdBQVcs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QkFDaEQsWUFBWSxFQUFFO29CQUNaLDZCQUE2QixFQUFFLEtBQUs7b0JBQ3BDLHlCQUF5QixFQUFFLENBQUMsR0FBRyxDQUFDO29CQUNoQyx5QkFBeUIsRUFBRSxDQUFDLEtBQUssQ0FBQztvQkFDbEMseUJBQXlCLEVBQUUsQ0FBQyxHQUFHLENBQUM7b0JBQ2hDLG1CQUFtQixFQUFFLHNCQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQztvQkFDMUMsY0FBYyxFQUFFLEtBQUs7aUJBQ3RCO2dCQUNELGtFQUFrRTtnQkFDbEUscUJBQXFCLEVBQUU7b0JBQ3JCLGFBQWEsRUFBRTt3QkFDYixFQUFFLE1BQU0sRUFBRSwwQkFBMEIsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUU7d0JBQ3JFLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUU7cUJBQ3BEO2lCQUNGO2FBQ0YsQ0FBQyxDQUFDO1lBQ0gsZ0NBQWdDLENBQUMscUJBQXFCLEdBQUcsMEJBQTBCLENBQUM7U0FDckY7UUFDRCxNQUFNLGFBQWEsR0FBRyxJQUFJLDRCQUFVLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSwyQkFBMkIsRUFBRTtZQUNuRixPQUFPLEVBQUUscUNBQXFDO1lBQzlDLGVBQWUsRUFBRSxnQ0FBZ0M7U0FDbEQsQ0FBQyxDQUFDO1FBRUgsSUFBSSx1QkFBUyxDQUFDLElBQUksRUFBRSxxQkFBcUIsRUFBRTtZQUN6QyxXQUFXLEVBQUUsK0JBQStCO1lBQzVDLEtBQUssRUFBRSxhQUFhLENBQUMsc0JBQXNCO1NBQzVDLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FDRjtBQTFORCx3REEwTkMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbi8vIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBNSVQtMFxuXG5pbXBvcnQgeyBTdGFjaywgU3RhY2tQcm9wcywgUmVtb3ZhbFBvbGljeSwgYXdzX3MzIGFzIHMzLCBhd3NfczNfZGVwbG95bWVudCBhcyBzM2RlcGxveSwgYXdzX2Nsb3VkZnJvbnQgYXMgY2xvdWRmcm9udCwgYXdzX2Nsb3VkZnJvbnRfb3JpZ2lucyBhcyBvcmlnaW5zLCBhd3NfbGFtYmRhIGFzIGxhbWJkYSwgYXdzX2lhbSBhcyBpYW0sIER1cmF0aW9uLCBDZm5PdXRwdXQsIGF3c19sb2dzIGFzIGxvZ3N9IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgTXlDdXN0b21SZXNvdXJjZSB9IGZyb20gJy4vbXktY3VzdG9tLXJlc291cmNlJztcbmltcG9ydCB7IGNyZWF0ZUhhc2ggfSBmcm9tICdjcnlwdG8nO1xuXG4vLyBSZWdpb24gdG8gT3JpZ2luIFNoaWVsZCBtYXBwaW5nIGJhc2VkIG9uIGxhdGVuY3kuIHRvIGJlIHVwZGF0ZWQgd2hlbiBuZXcgUmVnaW9uYWwgRWRnZSBDYWNoZXMgYXJlIGFkZGVkIHRvIENsb3VkRnJvbnQuXG5jb25zdCBPUklHSU5fU0hJRUxEX01BUFBJTkcgPSBuZXcgTWFwKFtbJ2FmLXNvdXRoLTEnLCAnZXUtd2VzdC0yJ10sIFsgJ2FwLWVhc3QtMScgLCdhcC1ub3J0aGVhc3QtMiddLCBbICdhcC1ub3J0aGVhc3QtMScsICdhcC1ub3J0aGVhc3QtMSddLCBbXG4gICdhcC1ub3J0aGVhc3QtMicsICdhcC1ub3J0aGVhc3QtMiddLCBbICdhcC1ub3J0aGVhc3QtMycsICdhcC1ub3J0aGVhc3QtMSddLCBbICdhcC1zb3V0aC0xJywgJ2FwLXNvdXRoLTEnXSwgWyAnYXAtc291dGhlYXN0LTEnLCdhcC1zb3V0aGVhc3QtMSddLCBbIFxuICAnYXAtc291dGhlYXN0LTInLCAnYXAtc291dGhlYXN0LTInXSwgWyAnY2EtY2VudHJhbC0xJywgJ3VzLWVhc3QtMSddLCBbICdldS1jZW50cmFsLTEnLCAnZXUtY2VudHJhbC0xJ10sIFsgJ2V1LW5vcnRoLTEnLCdldS1jZW50cmFsLTEnXSwgW1xuICAnZXUtc291dGgtMScsJ2V1LWNlbnRyYWwtMSddLCBbICdldS13ZXN0LTEnLCAnZXUtd2VzdC0xJ10sIFsgJ2V1LXdlc3QtMicsICdldS13ZXN0LTInXSwgWyAnZXUtd2VzdC0zJywgJ2V1LXdlc3QtMiddLCBbICdtZS1zb3V0aC0xJywgJ2FwLXNvdXRoLTEnXSwgW1xuICAnc2EtZWFzdC0xJywgJ3NhLWVhc3QtMSddLCBbICd1cy1lYXN0LTEnLCAndXMtZWFzdC0xJ10sIFsgJ3VzLWVhc3QtMicsJ3VzLWVhc3QtMiddLCBbICd1cy13ZXN0LTEnLCAndXMtd2VzdC0xJ10sIFsgJ3VzLXdlc3QtMicsICd1cy13ZXN0LTInXV0gKTtcblxuLy8gU3RhY2sgUGFyYW1ldGVyc1xuXG4vLyByZWxhdGVkIHRvIGFyY2hpdGVjdHVyZS4gSWYgc2V0IHRvIGZhbHNlLCB0cmFuc2Zvcm1lZCBpbWFnZXMgYXJlIG5vdCBzdG9yZWQgaW4gUzMsIGFuZCBhbGwgaW1hZ2UgcmVxdWVzdHMgbGFuZCBvbiBMYW1iZGFcbnZhciBTVE9SRV9UUkFOU0ZPUk1FRF9JTUFHRVMgPSAndHJ1ZSc7XG4vLyBQYXJhbWV0ZXJzIG9mIFMzIGJ1Y2tldCB3aGVyZSBvcmlnaW5hbCBpbWFnZXMgYXJlIHN0b3JlZFxudmFyIFMzX0lNQUdFX0JVQ0tFVF9OQU1FOnN0cmluZztcbi8vIENsb3VkRnJvbnQgcGFyYW1ldGVyc1xudmFyIENMT1VERlJPTlRfT1JJR0lOX1NISUVMRF9SRUdJT04gPSBPUklHSU5fU0hJRUxEX01BUFBJTkcuZ2V0KHByb2Nlc3MuZW52LkFXU19SRUdJT04gfHwgcHJvY2Vzcy5lbnYuQ0RLX0RFRkFVTFRfUkVHSU9OwqB8fCAndXMtZWFzdC0xJyk7XG52YXIgQ0xPVURGUk9OVF9DT1JTX0VOQUJMRUQgPSAndHJ1ZSc7XG4vLyBQYXJhbWV0ZXJzIG9mIHRyYW5zZm9ybWVkIGltYWdlc1xudmFyIFMzX1RSQU5TRk9STUVEX0lNQUdFX0VYUElSQVRJT05fRFVSQVRJT04gPSAnOTAnOyBcbnZhciBTM19UUkFOU0ZPUk1FRF9JTUFHRV9DQUNIRV9UVEwgPSAnbWF4LWFnZT0zMTYyMjQwMCc7XG4vLyBMYW1iZGEgUGFyYW1ldGVyc1xudmFyIExBTUJEQV9NRU1PUlkgPSAnMTUwMCc7XG52YXIgTEFNQkRBX1RJTUVPVVQgPSAnNjAnO1xudmFyIExPR19USU1JTkcgPSAnZmFsc2UnO1xuXG50eXBlIEltYWdlRGVsaXZlcnlDYWNoZUJlaGF2aW9yQ29uZmlnID0ge1xuICBvcmlnaW46IGFueTtcbiAgdmlld2VyUHJvdG9jb2xQb2xpY3k6IGFueTtcbiAgY2FjaGVQb2xpY3k6IGFueTtcbiAgZnVuY3Rpb25Bc3NvY2lhdGlvbnM6IGFueTtcbiAgcmVzcG9uc2VIZWFkZXJzUG9saWN5Pzphbnk7XG59O1xuXG50eXBlIExhbWJkYUVudiA9IHtcbiAgb3JpZ2luYWxJbWFnZUJ1Y2tldE5hbWU6IHN0cmluZyxcbiAgdHJhbnNmb3JtZWRJbWFnZUJ1Y2tldE5hbWU/OmFueTtcbiAgdHJhbnNmb3JtZWRJbWFnZUNhY2hlVFRMOiBzdHJpbmcsXG4gIHNlY3JldEtleTogc3RyaW5nLFxuICBsb2dUaW1pbmc6IHN0cmluZyxcbn1cblxuZXhwb3J0IGNsYXNzIEltYWdlT3B0aW1pemF0aW9uU3RhY2sgZXh0ZW5kcyBTdGFjayB7XG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzPzogU3RhY2tQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwgcHJvcHMpO1xuXG4gICAgLy8gQ2hhbmdlIHN0YWNrIHBhcmFtZXRlcnMgYmFzZWQgb24gcHJvdmlkZWQgY29udGV4dFxuICAgIFNUT1JFX1RSQU5TRk9STUVEX0lNQUdFUyA9IHRoaXMubm9kZS50cnlHZXRDb250ZXh0KCdTVE9SRV9UUkFOU0ZPUk1FRF9JTUFHRVMnKSB8fCBTVE9SRV9UUkFOU0ZPUk1FRF9JTUFHRVM7XG4gICAgUzNfVFJBTlNGT1JNRURfSU1BR0VfRVhQSVJBVElPTl9EVVJBVElPTiA9IHRoaXMubm9kZS50cnlHZXRDb250ZXh0KCdTM19UUkFOU0ZPUk1FRF9JTUFHRV9FWFBJUkFUSU9OX0RVUkFUSU9OJykgfHwgUzNfVFJBTlNGT1JNRURfSU1BR0VfRVhQSVJBVElPTl9EVVJBVElPTjsgXG4gICAgUzNfVFJBTlNGT1JNRURfSU1BR0VfQ0FDSEVfVFRMID0gdGhpcy5ub2RlLnRyeUdldENvbnRleHQoJ1MzX1RSQU5TRk9STUVEX0lNQUdFX0NBQ0hFX1RUTCcpIHx8IFMzX1RSQU5TRk9STUVEX0lNQUdFX0NBQ0hFX1RUTDtcbiAgICBTM19JTUFHRV9CVUNLRVRfTkFNRSA9IHRoaXMubm9kZS50cnlHZXRDb250ZXh0KCdTM19JTUFHRV9CVUNLRVRfTkFNRScpIHx8IFMzX0lNQUdFX0JVQ0tFVF9OQU1FO1xuICAgIENMT1VERlJPTlRfT1JJR0lOX1NISUVMRF9SRUdJT04gPSB0aGlzLm5vZGUudHJ5R2V0Q29udGV4dCgnQ0xPVURGUk9OVF9PUklHSU5fU0hJRUxEX1JFR0lPTicpIHx8IENMT1VERlJPTlRfT1JJR0lOX1NISUVMRF9SRUdJT047XG4gICAgQ0xPVURGUk9OVF9DT1JTX0VOQUJMRUQgPSB0aGlzLm5vZGUudHJ5R2V0Q29udGV4dCgnQ0xPVURGUk9OVF9DT1JTX0VOQUJMRUQnKSB8fCBDTE9VREZST05UX0NPUlNfRU5BQkxFRDtcbiAgICBMQU1CREFfTUVNT1JZID0gdGhpcy5ub2RlLnRyeUdldENvbnRleHQoJ0xBTUJEQV9NRU1PUlknKSB8fCBMQU1CREFfTUVNT1JZO1xuICAgIExBTUJEQV9USU1FT1VUID0gdGhpcy5ub2RlLnRyeUdldENvbnRleHQoJ0xBTUJEQV9USU1FT1VUJykgfHwgTEFNQkRBX1RJTUVPVVQ7XG4gICAgTE9HX1RJTUlORyA9IHRoaXMubm9kZS50cnlHZXRDb250ZXh0KCdMT0dfVElNSU5HJykgfHwgTE9HX1RJTUlORztcblxuICAgIC8vIENyZWF0ZSBzZWNyZXQga2V5IHRvIGJlIHVzZWQgYmV0d2VlbiBDbG91ZEZyb250IGFuZCBMYW1iZGEgVVJMIGZvciBhY2Nlc3MgY29udHJvbFxuICAgIGNvbnN0IFNFQ1JFVF9LRVkgPSBjcmVhdGVIYXNoKCdtZDUnKS51cGRhdGUodGhpcy5ub2RlLmFkZHIpLmRpZ2VzdCgnaGV4JykgO1xuXG4gICAgLy8gRm9yIHRoZSBidWNrZXQgaGF2aW5nIG9yaWdpbmFsIGltYWdlcywgZWl0aGVyIHVzZSBhbiBleHRlcm5hbCBvbmUsIG9yIGNyZWF0ZSBvbmUgd2l0aCBzb21lIHNhbXBsZXMgcGhvdG9zLlxuICAgIHZhciBvcmlnaW5hbEltYWdlQnVja2V0O1xuICAgIHZhciB0cmFuc2Zvcm1lZEltYWdlQnVja2V0O1xuICAgIHZhciBzYW1wbGVXZWJzaXRlRGVsaXZlcnk7XG5cbiAgICBpZiAoUzNfSU1BR0VfQlVDS0VUX05BTUUpIHtcbiAgICAgIG9yaWdpbmFsSW1hZ2VCdWNrZXQgPSBzMy5CdWNrZXQuZnJvbUJ1Y2tldE5hbWUodGhpcywnaW1wb3J0ZWQtb3JpZ2luYWwtaW1hZ2UtYnVja2V0JywgUzNfSU1BR0VfQlVDS0VUX05BTUUpO1xuICAgICAgbmV3IENmbk91dHB1dCh0aGlzLCAnT3JpZ2luYWxJbWFnZXNTM0J1Y2tldCcsIHtcbiAgICAgICAgZGVzY3JpcHRpb246ICdTMyBidWNrZXQgd2hlcmUgb3JpZ2luYWwgaW1hZ2VzIGFyZSBzdG9yZWQnLFxuICAgICAgICB2YWx1ZTogb3JpZ2luYWxJbWFnZUJ1Y2tldC5idWNrZXROYW1lXG4gICAgICB9KTsgIFxuICAgIH0gZWxzZSB7XG4gICAgICBvcmlnaW5hbEltYWdlQnVja2V0ID0gbmV3IHMzLkJ1Y2tldCh0aGlzLCAnczMtc2FtcGxlLW9yaWdpbmFsLWltYWdlLWJ1Y2tldCcsIHtcbiAgICAgICAgcmVtb3ZhbFBvbGljeTogUmVtb3ZhbFBvbGljeS5ERVNUUk9ZLFxuICAgICAgICBibG9ja1B1YmxpY0FjY2VzczogczMuQmxvY2tQdWJsaWNBY2Nlc3MuQkxPQ0tfQUxMLFxuICAgICAgICBlbmNyeXB0aW9uOiBzMy5CdWNrZXRFbmNyeXB0aW9uLlMzX01BTkFHRUQsXG4gICAgICAgIGVuZm9yY2VTU0w6IHRydWUsXG4gICAgICAgIGF1dG9EZWxldGVPYmplY3RzOiB0cnVlLCBcbiAgICAgIH0pO1xuICAgICAgbmV3IHMzZGVwbG95LkJ1Y2tldERlcGxveW1lbnQodGhpcywgJ0RlcGxveVdlYnNpdGUnLCB7XG4gICAgICAgIHNvdXJjZXM6IFtzM2RlcGxveS5Tb3VyY2UuYXNzZXQoJy4vaW1hZ2Utc2FtcGxlJyldLFxuICAgICAgICBkZXN0aW5hdGlvbkJ1Y2tldDogb3JpZ2luYWxJbWFnZUJ1Y2tldCxcbiAgICAgICAgZGVzdGluYXRpb25LZXlQcmVmaXg6ICdpbWFnZXMvcmlvLycsXG4gICAgICB9KTtcbiAgICAgIHZhciBzYW1wbGVXZWJzaXRlQnVja2V0ID0gbmV3IHMzLkJ1Y2tldCh0aGlzLCAnczMtc2FtcGxlLXdlYnNpdGUtYnVja2V0Jywge1xuICAgICAgICByZW1vdmFsUG9saWN5OiBSZW1vdmFsUG9saWN5LkRFU1RST1ksXG4gICAgICAgIGJsb2NrUHVibGljQWNjZXNzOiBzMy5CbG9ja1B1YmxpY0FjY2Vzcy5CTE9DS19BTEwsXG4gICAgICAgIGVuY3J5cHRpb246IHMzLkJ1Y2tldEVuY3J5cHRpb24uUzNfTUFOQUdFRCxcbiAgICAgICAgZW5mb3JjZVNTTDogdHJ1ZSxcbiAgICAgICAgYXV0b0RlbGV0ZU9iamVjdHM6IHRydWUsIFxuICAgICAgfSk7XG5cbiAgICAgIHNhbXBsZVdlYnNpdGVEZWxpdmVyeSA9IG5ldyBjbG91ZGZyb250LkRpc3RyaWJ1dGlvbih0aGlzLCAnd2Vic2l0ZURlbGl2ZXJ5RGlzdHJpYnV0aW9uJywge1xuICAgICAgICBjb21tZW50OiAnaW1hZ2Ugb3B0aW1pemF0aW9uIC0gc2FtcGxlIHdlYnNpdGUnLFxuICAgICAgICBkZWZhdWx0Um9vdE9iamVjdDogJ2luZGV4Lmh0bWwnLFxuICAgICAgICBkZWZhdWx0QmVoYXZpb3I6IHtcbiAgICAgICAgICBvcmlnaW46IG5ldyBvcmlnaW5zLlMzT3JpZ2luKHNhbXBsZVdlYnNpdGVCdWNrZXQpLFxuICAgICAgICAgIHZpZXdlclByb3RvY29sUG9saWN5OiBjbG91ZGZyb250LlZpZXdlclByb3RvY29sUG9saWN5LlJFRElSRUNUX1RPX0hUVFBTLFxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIG5ldyBDZm5PdXRwdXQodGhpcywgJ1NhbXBsZVdlYnNpdGVEb21haW4nLCB7XG4gICAgICAgIGRlc2NyaXB0aW9uOiAnU2FtcGxlIHdlYnNpdGUgZG9tYWluJyxcbiAgICAgICAgdmFsdWU6IHNhbXBsZVdlYnNpdGVEZWxpdmVyeS5kaXN0cmlidXRpb25Eb21haW5OYW1lXG4gICAgICB9KTtcbiAgICAgIG5ldyBDZm5PdXRwdXQodGhpcywgJ1NhbXBsZVdlYnNpdGVTM0J1Y2tldCcsIHtcbiAgICAgICAgZGVzY3JpcHRpb246ICdTMyBidWNrZXQgdXNlIGJ5IHRoZSBzYW1wbGUgd2Vic2l0ZScsXG4gICAgICAgIHZhbHVlOiBzYW1wbGVXZWJzaXRlQnVja2V0LmJ1Y2tldE5hbWVcbiAgICAgIH0pOyAgXG4gICAgICBuZXcgQ2ZuT3V0cHV0KHRoaXMsICdPcmlnaW5hbEltYWdlc1MzQnVja2V0Jywge1xuICAgICAgICBkZXNjcmlwdGlvbjogJ1MzIGJ1Y2tldCB3aGVyZSBvcmlnaW5hbCBpbWFnZXMgYXJlIHN0b3JlZCcsXG4gICAgICAgIHZhbHVlOiBvcmlnaW5hbEltYWdlQnVja2V0LmJ1Y2tldE5hbWVcbiAgICAgIH0pOyAgXG4gICAgfVxuICAgIFxuICAgIC8vIGNyZWF0ZSBidWNrZXQgZm9yIHRyYW5zZm9ybWVkIGltYWdlcyBpZiBlbmFibGVkIGluIHRoZSBhcmNoaXRlY3R1cmVcbiAgICBpZiAoU1RPUkVfVFJBTlNGT1JNRURfSU1BR0VTID09PSAndHJ1ZScpIHtcbiAgICAgIHRyYW5zZm9ybWVkSW1hZ2VCdWNrZXQgPSBuZXcgczMuQnVja2V0KHRoaXMsICdzMy10cmFuc2Zvcm1lZC1pbWFnZS1idWNrZXQnLCB7XG4gICAgICAgIHJlbW92YWxQb2xpY3k6IFJlbW92YWxQb2xpY3kuREVTVFJPWSxcbiAgICAgICAgYXV0b0RlbGV0ZU9iamVjdHM6IHRydWUsIFxuICAgICAgICBsaWZlY3ljbGVSdWxlczogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBleHBpcmF0aW9uOiBEdXJhdGlvbi5kYXlzKHBhcnNlSW50KFMzX1RSQU5TRk9STUVEX0lNQUdFX0VYUElSQVRJT05fRFVSQVRJT04pKSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgXSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIHByZXBhcmUgZW52IHZhcmlhYmxlIGZvciBMYW1iZGEgXG4gICAgdmFyIGxhbWJkYUVudjogTGFtYmRhRW52ID0ge1xuICAgICAgb3JpZ2luYWxJbWFnZUJ1Y2tldE5hbWU6IG9yaWdpbmFsSW1hZ2VCdWNrZXQuYnVja2V0TmFtZSxcbiAgICAgIHRyYW5zZm9ybWVkSW1hZ2VDYWNoZVRUTDogUzNfVFJBTlNGT1JNRURfSU1BR0VfQ0FDSEVfVFRMLFxuICAgICAgc2VjcmV0S2V5OiBTRUNSRVRfS0VZLFxuICAgICAgbG9nVGltaW5nOiBMT0dfVElNSU5HLFxuICAgIH07XG4gICAgaWYgKHRyYW5zZm9ybWVkSW1hZ2VCdWNrZXQpIGxhbWJkYUVudi50cmFuc2Zvcm1lZEltYWdlQnVja2V0TmFtZSA9IHRyYW5zZm9ybWVkSW1hZ2VCdWNrZXQuYnVja2V0TmFtZTtcblxuICAgIC8vIElBTSBwb2xpY3kgdG8gcmVhZCBmcm9tIHRoZSBTMyBidWNrZXQgY29udGFpbmluZyB0aGUgb3JpZ2luYWwgaW1hZ2VzXG4gICAgY29uc3QgczNSZWFkT3JpZ2luYWxJbWFnZXNQb2xpY3kgPSBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICBhY3Rpb25zOiBbJ3MzOkdldE9iamVjdCddLFxuICAgICAgcmVzb3VyY2VzOiBbJ2Fybjphd3M6czM6OjonK29yaWdpbmFsSW1hZ2VCdWNrZXQuYnVja2V0TmFtZSsnLyonXSxcbiAgICB9KTtcblxuICAgIC8vIHN0YXRlbWVudHMgb2YgdGhlIElBTSBwb2xpY3kgdG8gYXR0YWNoIHRvIExhbWJkYVxuICAgIHZhciBpYW1Qb2xpY3lTdGF0ZW1lbnRzID0gW3MzUmVhZE9yaWdpbmFsSW1hZ2VzUG9saWN5XTtcblxuICAgIC8vIENyZWF0ZSBMYW1iZGEgZm9yIGltYWdlIHByb2Nlc3NpbmdcbiAgICB2YXIgbGFtYmRhUHJvcHMgPSB7XG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTZfWCwgXG4gICAgICBoYW5kbGVyOiAnaW5kZXguaGFuZGxlcicsXG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQoJ2Z1bmN0aW9ucy9pbWFnZS1wcm9jZXNzaW5nJyksXG4gICAgICB0aW1lb3V0OiBEdXJhdGlvbi5zZWNvbmRzKHBhcnNlSW50KExBTUJEQV9USU1FT1VUKSksXG4gICAgICBtZW1vcnlTaXplOiBwYXJzZUludChMQU1CREFfTUVNT1JZKSxcbiAgICAgIGVudmlyb25tZW50OiBsYW1iZGFFbnYsXG4gICAgICBsb2dSZXRlbnRpb246IGxvZ3MuUmV0ZW50aW9uRGF5cy5PTkVfREFZLFxuICAgIH07XG4gICAgdmFyIGltYWdlUHJvY2Vzc2luZyA9IG5ldyBsYW1iZGEuRnVuY3Rpb24odGhpcywgJ2ltYWdlLW9wdGltaXphdGlvbicsIGxhbWJkYVByb3BzKTtcblxuICAgIC8vIEVuYWJsZSBMYW1iZGEgVVJMXG4gICAgY29uc3QgaW1hZ2VQcm9jZXNzaW5nVVJMID0gaW1hZ2VQcm9jZXNzaW5nLmFkZEZ1bmN0aW9uVXJsKHtcbiAgICAgIGF1dGhUeXBlOiBsYW1iZGEuRnVuY3Rpb25VcmxBdXRoVHlwZS5OT05FLFxuICAgIH0pO1xuXG4gICAgLy8gTGV2ZXJhZ2UgYSBjdXN0b20gcmVzb3VyY2UgdG8gZ2V0IHRoZSBob3N0bmFtZSBvZiB0aGUgTGFtYmRhVVJMXG4gICAgY29uc3QgaW1hZ2VQcm9jZXNzaW5nSGVscGVyID0gbmV3IE15Q3VzdG9tUmVzb3VyY2UodGhpcywgJ2N1c3RvbVJlc291cmNlJywge1xuICAgICAgVXJsOiBpbWFnZVByb2Nlc3NpbmdVUkwudXJsXG4gICAgfSk7XG5cbiAgICAvLyBDcmVhdGUgYSBDbG91ZEZyb250IG9yaWdpbjogUzMgd2l0aCBmYWxsYmFjayB0byBMYW1iZGEgd2hlbiBpbWFnZSBuZWVkcyB0byBiZSB0cmFuc2Zvcm1lZCwgb3RoZXJ3aXNlIHdpdGggTGFtYmRhIGFzIHNvbGUgb3JpZ2luXG4gICAgdmFyIGltYWdlT3JpZ2luO1xuXG4gICAgaWYgKHRyYW5zZm9ybWVkSW1hZ2VCdWNrZXQpIHtcbiAgICAgIGltYWdlT3JpZ2luID0gbmV3IG9yaWdpbnMuT3JpZ2luR3JvdXAgKHtcbiAgICAgICAgcHJpbWFyeU9yaWdpbjogbmV3IG9yaWdpbnMuUzNPcmlnaW4odHJhbnNmb3JtZWRJbWFnZUJ1Y2tldCwge1xuICAgICAgICAgIG9yaWdpblNoaWVsZFJlZ2lvbjogQ0xPVURGUk9OVF9PUklHSU5fU0hJRUxEX1JFR0lPTixcbiAgICAgICAgfSksXG4gICAgICAgIGZhbGxiYWNrT3JpZ2luOiBuZXcgb3JpZ2lucy5IdHRwT3JpZ2luKGltYWdlUHJvY2Vzc2luZ0hlbHBlci5ob3N0bmFtZSwge1xuICAgICAgICAgIG9yaWdpblNoaWVsZFJlZ2lvbjogQ0xPVURGUk9OVF9PUklHSU5fU0hJRUxEX1JFR0lPTixcbiAgICAgICAgICBjdXN0b21IZWFkZXJzOiB7XG4gICAgICAgICAgICAneC1vcmlnaW4tc2VjcmV0LWhlYWRlcic6IFNFQ1JFVF9LRVksXG4gICAgICAgICAgfSxcbiAgICAgICAgfSksIFxuICAgICAgICBmYWxsYmFja1N0YXR1c0NvZGVzOiBbNDAzXSxcbiAgICAgIH0pO1xuXG4gICAgICAvLyB3cml0ZSBwb2xpY3kgZm9yIExhbWJkYSBvbiB0aGUgczMgYnVja2V0IGZvciB0cmFuc2Zvcm1lZCBpbWFnZXNcbiAgICAgIHZhciBzM1dyaXRlVHJhbnNmb3JtZWRJbWFnZXNQb2xpY3kgPSBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgIGFjdGlvbnM6IFsnczM6UHV0T2JqZWN0J10sXG4gICAgICAgIHJlc291cmNlczogWydhcm46YXdzOnMzOjo6Jyt0cmFuc2Zvcm1lZEltYWdlQnVja2V0LmJ1Y2tldE5hbWUrJy8qJ10sXG4gICAgICB9KTtcbiAgICAgIGlhbVBvbGljeVN0YXRlbWVudHMucHVzaChzM1dyaXRlVHJhbnNmb3JtZWRJbWFnZXNQb2xpY3kpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zb2xlLmxvZyhcImVsc2UgdHJhbnNmb3JtZWRJbWFnZUJ1Y2tldFwiKTtcbiAgICAgIGltYWdlT3JpZ2luID0gbmV3IG9yaWdpbnMuSHR0cE9yaWdpbihpbWFnZVByb2Nlc3NpbmdIZWxwZXIuaG9zdG5hbWUsIHtcbiAgICAgICAgb3JpZ2luU2hpZWxkUmVnaW9uOiBDTE9VREZST05UX09SSUdJTl9TSElFTERfUkVHSU9OLFxuICAgICAgICBjdXN0b21IZWFkZXJzOiB7XG4gICAgICAgICAgJ3gtb3JpZ2luLXNlY3JldC1oZWFkZXInOiBTRUNSRVRfS0VZLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gYXR0YWNoIGlhbSBwb2xpY3kgdG8gdGhlIHJvbGUgYXNzdW1lZCBieSBMYW1iZGFcbiAgICBpbWFnZVByb2Nlc3Npbmcucm9sZT8uYXR0YWNoSW5saW5lUG9saWN5KFxuICAgICAgbmV3IGlhbS5Qb2xpY3kodGhpcywgJ3JlYWQtd3JpdGUtYnVja2V0LXBvbGljeScsIHtcbiAgICAgICAgc3RhdGVtZW50czogaWFtUG9saWN5U3RhdGVtZW50cyxcbiAgICAgIH0pLFxuICAgICk7XG5cbiAgICAvLyBDcmVhdGUgYSBDbG91ZEZyb250IEZ1bmN0aW9uIGZvciB1cmwgcmV3cml0ZXNcbiAgICBjb25zdCB1cmxSZXdyaXRlRnVuY3Rpb24gPSBuZXcgY2xvdWRmcm9udC5GdW5jdGlvbih0aGlzLCAndXJsUmV3cml0ZScsIHtcbiAgICAgIGNvZGU6IGNsb3VkZnJvbnQuRnVuY3Rpb25Db2RlLmZyb21GaWxlKHtmaWxlUGF0aDogJ2Z1bmN0aW9ucy91cmwtcmV3cml0ZS9pbmRleC5qcycsfSksXG4gICAgICBmdW5jdGlvbk5hbWU6IGB1cmxSZXdyaXRlRnVuY3Rpb24ke3RoaXMubm9kZS5hZGRyfWAsIFxuICAgIH0pO1xuXG4gICAgdmFyIGltYWdlRGVsaXZlcnlDYWNoZUJlaGF2aW9yQ29uZmlnOkltYWdlRGVsaXZlcnlDYWNoZUJlaGF2aW9yQ29uZmlnICA9IHtcbiAgICAgIG9yaWdpbjogaW1hZ2VPcmlnaW4sXG4gICAgICB2aWV3ZXJQcm90b2NvbFBvbGljeTogY2xvdWRmcm9udC5WaWV3ZXJQcm90b2NvbFBvbGljeS5SRURJUkVDVF9UT19IVFRQUyxcbiAgICAgIGNhY2hlUG9saWN5OiBuZXcgY2xvdWRmcm9udC5DYWNoZVBvbGljeSh0aGlzLCBgSW1hZ2VDYWNoZVBvbGljeSR7dGhpcy5ub2RlLmFkZHJ9YCwge1xuICAgICAgICBkZWZhdWx0VHRsOiBEdXJhdGlvbi5ob3VycygyNCksXG4gICAgICAgIG1heFR0bDogRHVyYXRpb24uZGF5cygzNjUpLFxuICAgICAgICBtaW5UdGw6IER1cmF0aW9uLnNlY29uZHMoMCksXG4gICAgICAgIHF1ZXJ5U3RyaW5nQmVoYXZpb3I6IGNsb3VkZnJvbnQuQ2FjaGVRdWVyeVN0cmluZ0JlaGF2aW9yLmFsbCgpXG4gICAgICB9KSxcbiAgICAgIGZ1bmN0aW9uQXNzb2NpYXRpb25zOiBbe1xuICAgICAgICBldmVudFR5cGU6IGNsb3VkZnJvbnQuRnVuY3Rpb25FdmVudFR5cGUuVklFV0VSX1JFUVVFU1QsXG4gICAgICAgIGZ1bmN0aW9uOiB1cmxSZXdyaXRlRnVuY3Rpb24sXG4gICAgICB9XSxcbiAgICB9XG5cbiAgICBpZiAoQ0xPVURGUk9OVF9DT1JTX0VOQUJMRUQgPT09ICd0cnVlJykge1xuICAgICAgLy8gQ3JlYXRpbmcgYSBjdXN0b20gcmVzcG9uc2UgaGVhZGVycyBwb2xpY3kuIENPUlMgYWxsb3dlZCBmb3IgYWxsIG9yaWdpbnMuXG4gICAgICBjb25zdCBpbWFnZVJlc3BvbnNlSGVhZGVyc1BvbGljeSA9IG5ldyBjbG91ZGZyb250LlJlc3BvbnNlSGVhZGVyc1BvbGljeSh0aGlzLCBgUmVzcG9uc2VIZWFkZXJzUG9saWN5JHt0aGlzLm5vZGUuYWRkcn1gLCB7XG4gICAgICAgIHJlc3BvbnNlSGVhZGVyc1BvbGljeU5hbWU6ICdJbWFnZVJlc3BvbnNlUG9saWN5JyxcbiAgICAgICAgY29yc0JlaGF2aW9yOiB7XG4gICAgICAgICAgYWNjZXNzQ29udHJvbEFsbG93Q3JlZGVudGlhbHM6IGZhbHNlLFxuICAgICAgICAgIGFjY2Vzc0NvbnRyb2xBbGxvd0hlYWRlcnM6IFsnKiddLFxuICAgICAgICAgIGFjY2Vzc0NvbnRyb2xBbGxvd01ldGhvZHM6IFsnR0VUJ10sXG4gICAgICAgICAgYWNjZXNzQ29udHJvbEFsbG93T3JpZ2luczogWycqJ10sXG4gICAgICAgICAgYWNjZXNzQ29udHJvbE1heEFnZTogRHVyYXRpb24uc2Vjb25kcyg2MDApLFxuICAgICAgICAgIG9yaWdpbk92ZXJyaWRlOiBmYWxzZSxcbiAgICAgICAgfSxcbiAgICAgICAgLy8gcmVjb2duaXppbmcgaW1hZ2UgcmVxdWVzdHMgdGhhdCB3ZXJlIHByb2Nlc3NlZCBieSB0aGlzIHNvbHV0aW9uXG4gICAgICAgIGN1c3RvbUhlYWRlcnNCZWhhdmlvcjoge1xuICAgICAgICAgIGN1c3RvbUhlYWRlcnM6IFtcbiAgICAgICAgICAgIHsgaGVhZGVyOiAneC1hd3MtaW1hZ2Utb3B0aW1pemF0aW9uJywgdmFsdWU6ICd2MS4wJywgb3ZlcnJpZGU6IHRydWUgfSxcbiAgICAgICAgICAgIHsgaGVhZGVyOiAndmFyeScsIHZhbHVlOiAnYWNjZXB0Jywgb3ZlcnJpZGU6IHRydWUgfSxcbiAgICAgICAgICBdLFxuICAgICAgICB9XG4gICAgICB9KTsgIFxuICAgICAgaW1hZ2VEZWxpdmVyeUNhY2hlQmVoYXZpb3JDb25maWcucmVzcG9uc2VIZWFkZXJzUG9saWN5ID0gaW1hZ2VSZXNwb25zZUhlYWRlcnNQb2xpY3k7XG4gICAgfVxuICAgIGNvbnN0IGltYWdlRGVsaXZlcnkgPSBuZXcgY2xvdWRmcm9udC5EaXN0cmlidXRpb24odGhpcywgJ2ltYWdlRGVsaXZlcnlEaXN0cmlidXRpb24nLCB7XG4gICAgICBjb21tZW50OiAnaW1hZ2Ugb3B0aW1pemF0aW9uIC0gaW1hZ2UgZGVsaXZlcnknLFxuICAgICAgZGVmYXVsdEJlaGF2aW9yOiBpbWFnZURlbGl2ZXJ5Q2FjaGVCZWhhdmlvckNvbmZpZ1xuICAgIH0pO1xuXG4gICAgbmV3IENmbk91dHB1dCh0aGlzLCAnSW1hZ2VEZWxpdmVyeURvbWFpbicsIHtcbiAgICAgIGRlc2NyaXB0aW9uOiAnRG9tYWluIG5hbWUgb2YgaW1hZ2UgZGVsaXZlcnknLFxuICAgICAgdmFsdWU6IGltYWdlRGVsaXZlcnkuZGlzdHJpYnV0aW9uRG9tYWluTmFtZVxuICAgIH0pO1xuICB9XG59XG4iXX0=